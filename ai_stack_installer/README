ArgusIoT service stack installer script.

Currently script is tested on both Vagrant & Server VMs(Win, ESXi) with Ubuntu.

It works reliably to install - Hbase, OpenTSDB & Grafana on Vagrant.

Script will need some changes to reliably install on a new AWS instance.
That will be taken up as a follow-up activity.

To stand a service stack on a VM involves 4 high level steps:
1. Creating an installer_bundle
2. Copying the installer bundle to the shared directory of your VM
3. Launching the VM
4. Using the installer bundle inside the VM to create a new service stack


Detailed steps:
===============

Create your new Vagrant VM to start a new stack:
------------------------------------------------
If you're using Vagrant for VMs, argus_exporter repo already has a ready made
Vagrantfile, that you can use, if you check out the repo from the host.
This Vagrantfile creates a Ubuntu VM with /argusiot dir as a shared directory
with the host.

In the dir on the host where you plan to have your work root:

mkdir argusiot; cd argusiot
git clone https://github.com/argusiot/data_platform
git clone https://github.com/argusiot/argus_exporter
cd argus_exporter

vagrant up
vagrant ssh

Clone the repositories (non-Vagrant VM):
---------------------------------------
# If it isn't already created on the vm:
mkdir /argusiot 
cd /argusiot
git clone https://github.com/argusiot/data_platform
git clone https://github.com/argusiot/argus_exporter


To generate the service stack installer bundle:
-----------------------------------------------
cd /argusiot
cd data_platform/ai_stack_installer
make installer_bundle
ls -l output/ai_stack_installer.tar.gz # expect to find this file

Install the stack:
------------------
cd ~/
mkdir new_stack ; cd new_stack
tar -xvf /argusiot/data_platform/ai_stack_installer/output/ai_stack_installer.tar.gz

sudo ./argusiot_service_stack_install.sh


Verification:
--------------
See if the needed ports are up:
netstat -l | grep 4242 
netstat -l | grep 3000
netstat -l | grep 2181

4242 - OpenTSDB
3000 - Grafana
2181 - ZooKeeper

telnet localhost 2181
stat
Expect to see Zookeeper version

Capabilities now enabled:
-------------------------
 -- OpenTSDB R/W will now work
 -- Accessing Grafana will work.

Finding ip address of the VM:
-----------------------------

The vagrant VM is initialized with a private network address that can be reached from the host. Find the private network address (should be 172.x.x.x):

ifconfig enp0s8


Adding data to OpenTSDB:
------------------------

Use the virtual exporter and importer to add data to the TSDB,
see the README for the virtual exporter for eloquent ways to do this:

/argusiot/argus_exporter/iot_gw/virtual_exporter/README.md


Accessing OpenTSDB viewer:
--------------------------

Open a web browser on your host and open (if private net ip is 172.28.128.3)

http://172.28.128.3:4242


Setting up Grafana:
-------------------

Open a web browser on your host and open (if private net ip is 172.28.128.3)

http://172.28.128.3:3000

Login with the default admin credentials (admin/admin).
Provide new password. No need to make this complicated on a VM, since the VM may be destroyed at any time)
If you want to add another user, do so as editor, but it is not needed on a VM, since the VM may be destroyed at any time).
(These steps are important when standing up the stack on cloud server)


Config the local OpenTSBD as a new data source, following this instruction:

https://grafana.com/docs/grafana/latest/datasources/add-a-data-source/

Choose OpenTSDB and explicitly type "localhost:4242". Don't leave the default.
You'll know where to type it when you see it.

Click [SAVE and TEST]

Now Grafana is ready to use, and as soon as you have added any data to OpenTSDB you can visualize it by creating dashboards or just "Exploring" the data.


Restarting services after restarting VM:
----------------------------------------

If you halt or restart your vagrant VM, OpenTSDB and ZooKeeper need to be restarted after you do vagrant up. Grafana willl restart automatically.

These are the steps:

vagrant up
vagrant ssh

# Start OpenTSDB and ZooKeeper
cd /usr/share/hbase/hbase-1.4.13/
sudo bin/start-hbase.sh
sudo jps
sudo service opentsdb restart

Note:
The hbase directory name may vary depending on what hbase version got installed.
You can get the correct name by using shell completion (TAB-key) to get the right one, instead of copy-pasting the command from above.


# Optional DB inspection steps:
    ./bin/hbase shell
    => list
       # (should see 4 tables: tsdb, tsdb-meta, tsdb-tree, tsdb-uid)
    => exit

# Optional : zookeeper verification
    telnet localhost 2181
    stat  # (should show: â€œZookeeper version: 3.4.10 . . . . <more stuff>]

To stop the OpenTSDB service (e.g. to restart with above steps):

sudo service opentsdb stop
cd /usr/share/hbase/hbase-1.4.13/
sudo bin/stop-hbase.sh
sudo jps
